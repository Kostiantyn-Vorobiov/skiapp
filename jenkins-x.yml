buildPack: javascript
pipelineConfig:
  env:
  - name: JENKINS_X_DOCKER_REGISTRY_SERVICE_HOST
    valueFrom:
      configMapKeyRef:
        key: docker.registry
        name: jenkins-x-docker-registry
  - name: JENKINS_X_DOCKER_REGISTRY_SERVICE_PORT
    value: "80"
  pipelines:
    pullRequest:
      postBuild:
        replace: true
        steps:
        - command: echo ============================== start replacing postBuild ====================================
          name: anchore-starting-postbuild
        - command: echo ============================== $DOCKER_REGISTRY/$ORG/$APP_NAME:$PREVIEW_VERSION ==============================
          name: anchore-outpout-image-path
        - command: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:$PREVIEW_VERSION
          dir: /workspace/source
          image: nodejs
          name: postbuild-post-build
        - command: echo ============================== start anchore image scan  ====================================
        - command: curl -s https://ci-tools.anchore.io/inline_scan-v0.6.0 | bash -s -- -r -p $DOCKER_REGISTRY/$ORG/$APP_NAME:$PREVIEW_VERSION
          name: anchore-image-scan
        - command: echo ============================== end anchore image scan ====================================
          name: anchore-end-postbuild       
